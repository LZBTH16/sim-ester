<div class="admin">
    <div class="admin-landing">
        <h1>Welcome {{username}}</h1>
        <p class="navigate"><a href="/list-order">All Orders</a></p>
    </div>

    <div class="container">
        <h2>Sales Graph</h2>
        <div>
            <!-- Buttons for filtering time range -->
            <button class="custom-button" id="filter-3-months">Last 3 Months</button>
            <button class="custom-button" id="filter-1-year">Last Year</button>
            <button class="custom-button" id="filter-all-time">All Time</button>
        </div>
        <table>
            <tbody>
                {{#each orders}}
                <tr>
                    <td>{{this.orderDate}}</td>
                    <td>${{this.sumTotal}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>

        <div>
            <canvas id="salesReportChart" width="800" height="400"></canvas>
        </div>
    </div>

    <div class="container">
        <h2>Total Units Sold Per Product</h2>
        <div>
            <canvas id="salesPerProductChart" width="800" height="400"></canvas>
        </div>
    </div>

    <div class="container">
        <h2>Customer Information</h2>
        <table>
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Customer ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Phone Number</th>
                    <th>Address</th>
                    <th>City</th>
                    <th>State</th>
                    <th>Postal Code</th>
                    <th>Country</th>
                </tr>
            </thead>
            <tbody>
                {{#each customerInfo}}
                <tr>
                    <td>{{this.username}}</td>
                    <td>{{this.customerId}}</td>
                    <td>{{this.firstName}}</td>
                    <td>{{this.lastName}}</td>
                    <td>{{this.email}}</td>
                    <td>{{this.phoneNum}}</td>
                    <td>{{this.address}}</td>
                    <td>{{this.city}}</td>
                    <td>{{this.state}}</td>
                    <td>{{this.postalCode}}</td>
                    <td>{{this.country}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>

    <div class="admin-actions">
        {{!-- to show that the product has been updated/deleted/added --}}
        {{#if successMessage}}
            <div class="decorative-button">
                {{successMessage}}
            </div>
        {{/if}}

        {{!-- to update products --}}
        <div class="all-actions">
            <form class="general-form" action="/admin/updateProduct" method="POST">
                <h2>Update Product</h2>
                <label>
                    <input type="number" name="productId" placeholder="" required>
                    <span>Product ID</span>
                </label>

                <label>
                    <input type="text" name="productName" placeholder="">
                    <span>Product Name</span>
                </label>
                
                <label>
                    <input type="text" name="productPrice" placeholder="">
                    <span>Price</span>
                </label>

                <label>
                    <textarea type="text" name="productDesc" placeholder="Description"></textarea>
                </label>

                <label>
                    <input type="password" name="adminPassword" placeholder="ADMIN PASSWORD" required>
                </label>

                <input class="custom-button" type="submit" value="Update Product">
            </form>

            {{!-- to delete products --}}
            <form class="general-form" action="/admin/deleteProduct" method="POST">
                <h2>Delete Product</h2>
                <label>
                    <input type="number" name="productId" placeholder="" required>
                    <span>Product ID</span>
                </label>

                <label>
                    <input type="password" name="adminPassword" placeholder="ADMIN PASSWORD" required>
                </label>

                <div class="action">
                    <input class="custom-button" type="submit" value="Delete Product">
                </div>
            </form>

            {{!-- to add a new product --}}
            <form class="general-form" action="/admin/addProduct" method="POST">
                <h2>Add Product</h2>
                <label>
                    <input type="text" name="productName" placeholder="">
                    <span>Product Name</span>
                </label>

                <label>
                    <input type="text" name="productPrice" placeholder="">
                    <span>Price</span>
                </label>

                <label>
                    <input type="number" name="categoryId" placeholder="">
                    <span>Category ID</span>
                </label>

                <label>
                    <textarea type="text" name="productDesc" placeholder="Description"></textarea>
                </label>

                <label>
                    <input type="password" name="adminPassword" placeholder="ADMIN PASSWORD" required>
                </label>

                <div class="action">
                    <input class="custom-button" type="submit" value="Add Product">
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const orders = JSON.parse('{{{orders}}}');
    const productData = JSON.parse('{{{productData}}}');
    const ctx = document.getElementById('salesReportChart').getContext('2d');
    const productCtx = document.getElementById('salesPerProductChart').getContext('2d');

    // Function to filter orders based on time range
    const filterOrdersByTimeRange = (timeRange) => {
        const now = new Date();
        return orders.filter(order => {
            const orderDate = new Date(order.orderDate);

            if (timeRange === '3-months') {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(now.getMonth() - 3);
                return orderDate >= threeMonthsAgo;
            }

            if (timeRange === '1-year') {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(now.getFullYear() - 1);
                return orderDate >= oneYearAgo;
            }

            return true; // "All Time" returns all orders
        });
    };

    // Initial chart data and instance for sales over time
    const chartData = {
        labels: orders.map(order => order.orderDate),
        datasets: [{
            label: 'Revenue',
            data: orders.map(order => order.sumTotal),
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderWidth: 2,
            fill: true,
            tension: 0.1
        }]
    };

    const chart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.7)',
                    bodyColor: '#fff',
                    callbacks: {
                        label: function(tooltipItem) {
                            const revenue = tooltipItem.raw;
                            const productsSold = orders[tooltipItem.dataIndex].productsSold;
                            return `$${revenue.toLocaleString()} | Products Sold: ${productsSold}`;
                        }
                    },
                    displayColors: false
                }
            },
            scales: {
                x: { title: { display: true } },
                y: {
                    title: { display: true },
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Update sales chart based on filtered orders
    const updateChart = (filteredOrders) => {
        chart.data.labels = filteredOrders.map(order => order.orderDate);
        chart.data.datasets[0].data = filteredOrders.map(order => order.sumTotal);
        chart.update();
    };

    // Add event listeners to filter buttons
    document.getElementById('filter-3-months').addEventListener('click', () => {
        const filteredOrders = filterOrdersByTimeRange('3-months');
        updateChart(filteredOrders);
    });

    document.getElementById('filter-1-year').addEventListener('click', () => {
        const filteredOrders = filterOrdersByTimeRange('1-year');
        updateChart(filteredOrders);
    });

    document.getElementById('filter-all-time').addEventListener('click', () => {
        const filteredOrders = filterOrdersByTimeRange('all-time');
        updateChart(filteredOrders);
    });

    // Sales Per Product Chart
    const productLabels = productData.map(product => product.productName);
    const productSales = productData.map(product => product.salesCount);

    new Chart(productCtx, {
        type: 'bar',
        data: {
            labels: productLabels,
            datasets: [{
                label: 'Units Sold',
                data: productSales,
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return `${tooltipItem.raw.toLocaleString()} Units`;
                        }
                    }
                }
            },
            scales: {
                x: { title: { display: true } },
                y: {
                    title: { display: true },
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
</script>
